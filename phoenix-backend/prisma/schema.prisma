generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider          = "postgresql"
  url               = env("DATABASE_URL")
  shadowDatabaseUrl = env("SHADOW_DATABASE_URL")
}

enum Sender {
  user
  admin
}

enum TicketStatus {
  open
  pending
  closed
}

// ⬅️ نوع تیکت
enum TicketType {
  tech // پشتیبانی فنی
  therapy // ارتباط با درمانگر
}

model Ticket {
  id          String       @id @default(uuid())
  title       String
  description String
  contact     String?
  status      TicketStatus @default(open)
  type        TicketType   @default(tech)

  pinned       Boolean @default(false)
  unread       Boolean @default(false)
  openedById   String?
  openedByName String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  messages Message[]
}

enum MessageType {
  text
  voice
  image
  file
}

model Message {
  id String @id @default(uuid())

  ticketId String
  ticket   Ticket @relation(fields: [ticketId], references: [id], onDelete: Cascade)

  sender Sender

  type        MessageType @default(text)
  text        String?
  fileUrl     String?
  mime        String?
  size        Int?
  durationSec Int?
  createdAt   DateTime    @default(now())

  @@index([ticketId])
}

enum AdminRole {
  owner
  manager
  agent
}

model Admin {
  id           String    @id @default(uuid())
  email        String    @unique
  name         String
  apiKey       String    @unique
  passwordHash String?
  role         AdminRole @default(agent)
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt

  sessions AdminSession[]
}

model AdminSession {
  id        String    @id @default(uuid())
  adminId   String
  admin     Admin     @relation(fields: [adminId], references: [id], onDelete: Cascade)
  token     String    @unique
  createdAt DateTime  @default(now())
  expiresAt DateTime
  revokedAt DateTime?
}

model AiMemory {
  id        String   @id @default(uuid())
  userId    String   @unique
  summary   String   @default("")
  updatedAt DateTime @updatedAt
  createdAt DateTime @default(now())
}

/**
 * ----------- User + Subscription برای اپ ققنوس -----------
 */

enum SubscriptionStatus {
  pending
  active
  expired
  canceled
}

// ✅ پلن را به صورت رشته ذخیره می‌کنیم: 'free' | 'pro' | 'vip'
model User {
  id        String    @id @default(uuid())
  phone     String    @unique
  fullName  String?   @default("")
  gender    String? // male / female / other
  birthDate DateTime?

  plan          String    @default("free") // 'free' | 'pro' | 'vip'
  planExpiresAt DateTime?

  profileCompleted Boolean @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  subscriptions Subscription[]

  // ✅ Announcements
  announcementSeen AnnouncementSeen[]

  // ✅ Pelekan (legacy root state)
  pelekanProgress PelekanProgress?

  // ✅ Assessments (legacy, keep)
  assessments AssessmentResult[]

  // ✅ NEW: Assessment Sessions (برای ذخیره پایدار آزمون‌های در حال انجام)
  assessmentSessions AssessmentSession[] // ✅ NEW

  // ✅ Pelekan (new relations)
  pelekanDayProgress  PelekanDayProgress[]
  pelekanTaskProgress PelekanTaskProgress[]
  xpLedger            XpLedger[]
  medals              UserMedal[]
  identityBadges      UserIdentityBadge[]
  streak              PelekanStreak?
  noContactLogs       NoContactLog[]

  // ✅ NEW: Review session (بازسنجی + آیا برمی‌گرده؟) فقط یک‌بار
  pelekanReviewSession PelekanReviewSession? // ✅ NEW

  // ✅ NEW: Bastan (اقدام‌محور)
  bastanState           BastanState?
  bastanActionProgress  BastanActionProgress[]
  bastanSubtaskProgress BastanSubtaskProgress[]
}

model Subscription {
  id String @id @default(uuid())

  userId String?
  user   User?   @relation(fields: [userId], references: [id], onDelete: Cascade)

  phone     String
  authority String  @unique
  refId     String?

  amount Int
  months Int
  plan   String
  status SubscriptionStatus @default(pending)

  expiresAt DateTime

  createdAt DateTime  @default(now())
  paidAt    DateTime?

  @@index([userId])
  @@index([phone])
}

/**
 * -------------------- Announcements --------------------
 */

enum AnnouncementPlacement {
  top_banner
}

enum AnnouncementLevel {
  info
  warning
  critical
}

model Announcement {
  id        String                @id @default(uuid())
  title     String?
  message   String
  level     AnnouncementLevel     @default(info)
  placement AnnouncementPlacement @default(top_banner)

  // ✅ اجباری/اختیاری (اجباری یعنی dismissible=false)
  dismissible Boolean @default(true)

  // ✅ فعال/غیرفعال
  enabled Boolean @default(true)

  targetFree     Boolean @default(true)
  targetPro      Boolean @default(true)
  targetExpiring Boolean @default(false)
  targetExpired  Boolean @default(false)

  // زمان‌بندی
  startAt DateTime?
  endAt   DateTime?

  // ترتیب نمایش (عدد بزرگ‌تر یعنی بالاتر)
  priority Int @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  seenBy AnnouncementSeen[]

  @@index([enabled, placement, priority])
  @@index([startAt, endAt])
}

model AnnouncementSeen {
  id             String   @id @default(uuid())
  announcementId String
  userId         String
  seenAt         DateTime @default(now())

  announcement Announcement @relation(fields: [announcementId], references: [id], onDelete: Cascade)
  user         User         @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([announcementId, userId])
  @@index([userId])
  @@index([announcementId])
}

/**
 * -------------------- Pelekan Progress (legacy root) --------------------
 */

model PelekanProgress {
  id String @id @default(uuid())

  userId String @unique
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  stepIndex Int @default(1)
  dayIndex  Int @default(0)

  gems   Int @default(0)
  streak Int @default(0)

  startedAt    DateTime @default(now())
  lastActiveAt DateTime @default(now())

  resetCount Int       @default(0)
  resetAt    DateTime?

  version Int @default(1)

  bastanIntroAudioStartedAt   DateTime?
  bastanIntroAudioCompletedAt DateTime?
  bastanPaywallShownAt        DateTime?
  bastanUnlockedAt            DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([lastActiveAt])
  @@index([updatedAt])
}

/**
 * -------------------- Assessments (legacy) --------------------
 */

enum AssessmentKind {
  hb_baseline
  heartbreak_simple
  heartbreak_scales
  relationship_rescan
  ex_returns
}

model AssessmentResult {
  id String @id @default(uuid())

  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  kind AssessmentKind

  totalScore Int?
  scales     Json?

  wave    Int      @default(1)
  takenAt DateTime @default(now())

  proLocked Boolean @default(false)

  @@unique([userId, kind, wave])
  @@index([userId])
  @@index([kind])
  @@index([userId, kind])
}

enum AssessmentSessionStatus {
  in_progress
  completed
}

model AssessmentSession {
  id String @id @default(uuid())

  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  kind   AssessmentKind
  status AssessmentSessionStatus @default(in_progress)

  currentIndex Int @default(0)
  totalItems   Int @default(0)

  answersJson Json?
  totalScore  Int?
  scalesJson  Json?

  proLocked Boolean @default(false)

  startedAt   DateTime  @default(now())
  completedAt DateTime?

  resultSeenAt DateTime?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([userId, kind])
  @@index([userId, kind])
}

/**
 * ======================================================================
 * =========================  PELEKAN v1 MODELS  =========================
 * ======================================================================
 */

enum PelekanStageCode {
  bastan
  gosastan
  sookhtan
  sarashtan
  ziestan
  sakhtan
  rastan
}

model PelekanStage {
  id        String           @id @default(uuid())
  code      PelekanStageCode @unique
  titleFa   String
  sortOrder Int

  days PelekanDay[]
}

model PelekanDay {
  id      String       @id @default(uuid())
  stageId String
  stage   PelekanStage @relation(fields: [stageId], references: [id], onDelete: Cascade)

  dayNumberInStage Int
  globalDayNumber  Int @unique

  title       String?
  description String?

  requiredPercent Int @default(70)

  tasks          PelekanTask[]
  userProgress   PelekanDayProgress[]
  taskProgresses PelekanTaskProgress[]

  @@index([stageId, dayNumberInStage])
}

model PelekanTask {
  id    String     @id @default(uuid())
  dayId String
  day   PelekanDay @relation(fields: [dayId], references: [id], onDelete: Cascade)

  titleFa     String
  description String?
  sortOrder   Int     @default(0)

  weightPercent Int @default(10)

  xpReward   Int     @default(0)
  isRequired Boolean @default(false)

  userProgress PelekanTaskProgress[]

  @@index([dayId, sortOrder])
}

enum PelekanDayStatus {
  active
  completed
  failed
}

model PelekanDayProgress {
  id String @id @default(uuid())

  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  dayId String
  day   PelekanDay @relation(fields: [dayId], references: [id], onDelete: Cascade)

  status PelekanDayStatus @default(active)

  completionPercent Int @default(0)

  startedAt      DateTime  @default(now())
  deadlineAt     DateTime?
  lastActivityAt DateTime  @default(now())
  completedAt    DateTime?

  minDoneAt  DateTime?
  fullDoneAt DateTime?

  unlockedNextAt DateTime?

  resetCount  Int       @default(0)
  lastResetAt DateTime?

  xpEarned Int @default(0)

  @@unique([userId, dayId])
  @@index([userId, status])
  @@index([userId, startedAt])
}

model PelekanTaskProgress {
  id String @id @default(uuid())

  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  taskId String
  task   PelekanTask @relation(fields: [taskId], references: [id], onDelete: Cascade)

  dayId String
  day   PelekanDay @relation(fields: [dayId], references: [id], onDelete: Cascade)

  isDone Boolean   @default(false)
  doneAt DateTime?

  @@unique([userId, taskId])
  @@index([userId, dayId])
}

model XpLedger {
  id String @id @default(uuid())

  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  amount Int
  reason String

  refType String?
  refId   String?

  createdAt DateTime @default(now())

  @@index([userId, createdAt])
}

model Medal {
  id          String   @id @default(uuid())
  code        String   @unique
  titleFa     String
  description String?
  iconKey     String?
  createdAt   DateTime @default(now())

  users UserMedal[]
}

model UserMedal {
  id String @id @default(uuid())

  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  medalId String
  medal   Medal  @relation(fields: [medalId], references: [id], onDelete: Cascade)

  earnedAt DateTime @default(now())

  @@unique([userId, medalId])
  @@index([userId])
}

model IdentityBadge {
  id          String   @id @default(uuid())
  code        String   @unique
  titleFa     String
  description String?
  iconKey     String?
  createdAt   DateTime @default(now())

  users UserIdentityBadge[]
}

model UserIdentityBadge {
  id String @id @default(uuid())

  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  badgeId String
  badge   IdentityBadge @relation(fields: [badgeId], references: [id], onDelete: Cascade)

  earnedAt DateTime @default(now())

  @@unique([userId, badgeId])
  @@index([userId])
}

model PelekanStreak {
  userId String @id
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  currentDays Int @default(0)
  bestDays    Int @default(0)

  lastCompletedAt DateTime?
  yellowCardAt    DateTime?

  updatedAt DateTime @updatedAt
}

/**
 * -------------------- NoContact (legacy) --------------------
 * ✅ ارتقا دادیم به سه‌حالته، ولی فیلدهای قبلی را نگه داشتیم تا دیتالاس/شکست کد قدیمی نداشته باشیم.
 */

enum NoContactEventType {
  none // هیچ تماس/چک‌کردن
  role_based // تماس نقش‌محور (کار/فرزند) => تخلف حساب نمی‌شود
  emotional // تماس هیجانی/چک‌کردن/پیام غیرضروری => تخلف
}

model NoContactLog {
  id String @id @default(uuid())

  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  dateKey String

  // legacy
  hadContact Boolean @default(false)
  note       String?

  // ✅ NEW
  eventType NoContactEventType? // اگر null بود، از hadContact استفاده می‌کنیم
  eventAt   DateTime?

  createdAt DateTime @default(now())

  @@unique([userId, dateKey])
  @@index([userId, dateKey])
}

/**
 * ======================================================================
 * =====================  PELEKAN BASTAN (ACTION-BASED)  =================
 * ======================================================================
 * مرحله «بستن» اقدام‌محور است (۸ اقدام).
 * - ویس اول رایگان است.
 * - ورود به اقدامات (و زیر اقدام‌ها) pro-locked است.
 * - باز شدن «گسستن» فقط بعد از:
 * 1) تکمیل هر ۸ اقدام
 * 2) رعایت حداقل زیر اقدام‌ها در هر اقدام
 * 3) امضای تعهدنامه
 * 4) پاس شدن چک امنیتی ۲۴ ساعته
 */

enum BastanActionCode {
  reality_check // 1️⃣ Reality Check
  adult_responsibility // 2️⃣ Adult Responsibility
  unsent_letter // 3️⃣ Unsent Letter (72h lock)
  trigger_detox // 4️⃣ Trigger Detox
  limited_contact // 5️⃣ FRL Protocol
  meaning_learning // 6️⃣ Meaning & Learning
  closure_ritual // 7️⃣ Closure Ritual
  commitment_contract // 8️⃣ Commitment Contract
}

enum BastanProgressStatus {
  locked
  active
  done
}

enum BastanSubtaskKind {
  checklist
  form
  text
  choice
  audio
  signature
  confirm
}

model BastanActionDefinition {
  id        String           @id @default(uuid())
  code      BastanActionCode @unique
  titleFa   String
  sortOrder Int

  // حداقل زیر اقدام‌های لازم (مثلاً 4 از 6)
  minRequiredSubtasks Int @default(0)
  totalSubtasks       Int @default(0)

  // امتیازدهی پایه (اختیاری)
  xpPerSubtask Int @default(0)
  xpOnComplete Int @default(0)

  // اگر این اقدام مدال/بج دارد، از codeها استفاده می‌کنیم (seed جدا)
  medalCode String?
  badgeCode String?

  // paywall
  isProLocked Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  subtasks          BastanSubtaskDefinition[]
  progress          BastanActionProgress[]
  subtaskProgresses BastanSubtaskProgress[]

  @@index([sortOrder])
}

model BastanSubtaskDefinition {
  id String @id @default(uuid())

  actionId String
  action   BastanActionDefinition @relation(fields: [actionId], references: [id], onDelete: Cascade)

  key     String
  titleFa String
  helpFa  String?
  kind    BastanSubtaskKind @default(form)

  // برخی زیر اقدام‌ها اجباری‌اند (مثل نامه/سوگند/قفل)
  isRequired Boolean @default(false)

  // اگر چیزی رایگان باشد (مثلاً ویس اول) اینجا مشخص می‌کنیم
  isFree Boolean @default(false)

  // امتیاز اختصاصی (اگر خواستی از xpPerSubtask override کنی)
  xpReward Int @default(0)

  sortOrder Int @default(0)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  userProgress BastanSubtaskProgress[]

  @@unique([actionId, key])
  @@index([actionId, sortOrder])
}

model BastanActionProgress {
  id String @id @default(uuid())

  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  actionId String
  action   BastanActionDefinition @relation(fields: [actionId], references: [id], onDelete: Cascade)

  status BastanProgressStatus @default(locked)

  // شمارنده‌ها برای محاسبه سریع UI
  doneSubtasksCount   Int @default(0)
  minRequiredSubtasks Int @default(0)
  totalSubtasks       Int @default(0)

  startedAt   DateTime?
  completedAt DateTime?

  xpEarned Int @default(0)

  // خروجی‌های جمع‌بندی هر اقدام (مثلاً جمله نهایی اقدام ۱)
  resultJson Json?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([userId, actionId])
  @@index([userId, status])
}

model BastanSubtaskProgress {
  id String @id @default(uuid())

  userId String
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  subtaskId String
  subtask   BastanSubtaskDefinition @relation(fields: [subtaskId], references: [id], onDelete: Cascade)

  actionId String
  action   BastanActionDefinition @relation(fields: [actionId], references: [id], onDelete: Cascade)

  isDone Boolean   @default(false)
  doneAt DateTime?

  // داده‌ی هر زیر اقدام:
  // - فرم‌ها/لیست‌ها
  // - متن نامه
  // - انتخاب‌ها
  // - اطلاعات امضا
  // - برای نامه: lockUntil (72h)
  payloadJson Json?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([userId, subtaskId])
  @@index([userId, actionId])
}

/**
 * وضعیت کلی مرحله بستن برای هر کاربر (Gate + قرارداد + قفل گسستن)
 */
model BastanState {
  userId String @id
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  // آیا ویس مقدمه رایگان شنیده شده؟ (برای UI سریع)
  introAudioCompletedAt DateTime?

  // قرارداد (اقدام ۸)
  contractNameTyped     String?
  contractSignedAt      DateTime?
  contractSignatureJson Json? // signature pad یا هر فرم امضا

  // چک امنیتی ۲۴ ساعته (Gate نهایی)
  lastSafetyCheckAt     DateTime?
  lastSafetyCheckResult NoContactEventType?
  safetyWindowStartsAt  DateTime? // اگر emotional شد، از نو شروع می‌شود

  // باز شدن مرحله گسستن
  gosastanUnlockedAt DateTime?

  // برای دیباگ/ری‌انتر کردن UI
  updatedAt DateTime @updatedAt
  createdAt DateTime @default(now())
}

/**
 * -------------------- Review Question Bank (DB) --------------------
 */

enum ReviewTestNo {
  TEST1
  TEST2
}

model ReviewQuestionSet {
  id          String  @id @default(uuid())
  code        String
  version     Int
  titleFa     String?
  description String?
  isActive    Boolean @default(true)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  questions ReviewQuestion[]
  sessions  PelekanReviewSession[]

  @@unique([code, version])
  @@index([code, isActive])
}

model ReviewQuestion {
  id            String            @id @default(uuid())
  questionSetId String
  questionSet   ReviewQuestionSet @relation(fields: [questionSetId], references: [id], onDelete: Cascade)

  testNo ReviewTestNo
  order  Int

  key    String?
  textFa String
  helpFa String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  options ReviewOption[]

  @@unique([questionSetId, testNo, order])
  @@index([questionSetId, testNo])
}

model ReviewOption {
  id String @id @default(uuid())

  questionId String
  question   ReviewQuestion @relation(fields: [questionId], references: [id], onDelete: Cascade)

  order   Int
  labelFa String
  value   Int

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([questionId, order])
  @@unique([questionId, value])
}

/**
 * -------------------- Pelekan Review Session (NEW) --------------------
 */

enum PelekanReviewStatus {
  in_progress
  completed_locked
  unlocked
}

model PelekanReviewSession {
  id String @id @default(uuid())

  userId String @unique
  user   User   @relation(fields: [userId], references: [id], onDelete: Cascade)

  status PelekanReviewStatus @default(in_progress)

  // ✅ برگشت به نوع قبلی DB (تا دیتالاس نداشته باشیم)
  chosenPath String? // "skip_review" | "review"

  // ✅ برگشت به نوع قبلی DB (تا دیتالاس نداشته باشیم)
  currentTest  Int @default(1) // 1 یا 2
  currentIndex Int @default(0)

  startedAt      DateTime  @default(now())
  completedAt    DateTime?
  paywallShownAt DateTime?
  unlockedAt     DateTime?

  test1CompletedAt DateTime?
  test2CompletedAt DateTime?
  test2SkippedAt   DateTime?

  answersJson Json?
  resultJson  Json?

  // ✅ ستونِ جدیدی که DB نداره و باید اضافه بشه
  questionSetId String?
  questionSet   ReviewQuestionSet? @relation(fields: [questionSetId], references: [id], onDelete: SetNull)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([questionSetId])
}
