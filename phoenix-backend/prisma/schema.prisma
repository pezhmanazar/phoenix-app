generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum Sender {
  user
  admin
}

enum TicketStatus {
  open
  pending
  closed
}

// â¬…ï¸ Ù†ÙˆØ¹ ØªÛŒÚ©Øª
enum TicketType {
  tech     // Ù¾Ø´ØªÛŒØ¨Ø§Ù†ÛŒ ÙÙ†ÛŒ
  therapy  // Ø§Ø±ØªØ¨Ø§Ø· Ø¨Ø§ Ø¯Ø±Ù…Ø§Ù†Ú¯Ø±
}

model Ticket {
  id          String       @id @default(uuid())
  title       String
  description String
  contact     String?
  status      TicketStatus @default(open)
  type        TicketType   @default(tech)

  pinned       Boolean @default(false)
  unread       Boolean @default(false)
  openedById   String?
  openedByName String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  messages Message[]
}

enum MessageType {
  text
  voice
  image
  file
}

model Message {
  id String @id @default(uuid())

  ticketId String
  ticket   Ticket @relation(fields: [ticketId], references: [id], onDelete: Cascade)

  sender Sender

  type        MessageType @default(text)
  text        String?
  fileUrl     String?
  mime        String?
  size        Int?
  durationSec Int?
  createdAt   DateTime @default(now())

  @@index([ticketId])
}

enum AdminRole {
  owner
  manager
  agent
}

model Admin {
  id           String    @id @default(uuid())
  email        String    @unique
  name         String
  apiKey       String    @unique
  passwordHash String?
  role         AdminRole @default(agent)
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt

  sessions AdminSession[]
}

model AdminSession {
  id        String   @id @default(uuid())
  adminId   String
  admin     Admin    @relation(fields: [adminId], references: [id], onDelete: Cascade)
  token     String   @unique
  createdAt DateTime @default(now())
  expiresAt DateTime
  revokedAt DateTime?
}

model AiMemory {
  id        String   @id @default(uuid())
  userId    String   @unique
  summary   String   @default("")
  updatedAt DateTime @updatedAt
  createdAt DateTime @default(now())
}

/* ----------- User + Subscription Ø¨Ø±Ø§ÛŒ Ø§Ù¾ Ù‚Ù‚Ù†ÙˆØ³ ----------- */

enum SubscriptionStatus {
  active
  expired
  canceled
}

/** ğŸ‘‡ Ù¾Ù„Ù† Ø§Ø³ØªØ§Ù†Ø¯Ø§Ø±Ø¯ Ù‚Ù‚Ù†ÙˆØ³ */
enum Plan {
  free
  pro
  vip
}

model User {
  id        String   @id @default(uuid())
  phone     String   @unique
  fullName  String?  @default("")
  gender    String?  // male / female / other (Ø³Ø§Ø¯Ù‡ Ù†Ú¯Ù‡ Ù…ÛŒâ€ŒØ¯Ø§Ø±ÛŒÙ…)
  birthDate DateTime?

  // âœ… ÙÛŒÙ„Ø¯Ù‡Ø§ÛŒ Ø±Ø³Ù…ÛŒ Ø§Ø´ØªØ±Ø§Ú©
  plan          Plan      @default(free) // free | pro | vip
  planExpiresAt DateTime?               // ØªØ§Ø±ÛŒØ® Ø§Ù†Ù‚Ø¶Ø§ÛŒ Ù‡Ù…ÛŒÙ† Ù¾Ù„Ù†

  // (Ø§Ø®ØªÛŒØ§Ø±ÛŒ ÙˆÙ„ÛŒ Ù…ÙÛŒØ¯ â€“ Ø§Ú¯Ø± Ù†Ø®ÙˆØ§Ø³ØªÛŒ Ù…ÛŒâ€ŒØªÙˆÙ†ÛŒ Ø­Ø°ÙØ´ Ú©Ù†ÛŒ)
  profileCompleted Boolean @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  subscriptions Subscription[]
}

model Subscription {
  id        String               @id @default(uuid())
  userId    String
  user      User                 @relation(fields: [userId], references: [id], onDelete: Cascade)

  authority String             // Ú©Ø¯ Ø²Ø±ÛŒÙ†â€ŒÙ¾Ø§Ù„
  refId     String             // ref_id Ø²Ø±ÛŒÙ†â€ŒÙ¾Ø§Ù„
  amount    Int
  months    Int
  plan      String             // ÙØ¹Ù„Ø§Ù‹ "pro" Ù†Ú¯Ù‡ Ù…ÛŒâ€ŒØ¯Ø§Ø±ÛŒÙ…
  status    SubscriptionStatus @default(active)
  expiresAt DateTime

  createdAt DateTime @default(now())

  @@index([userId])
  @@index([authority])
}